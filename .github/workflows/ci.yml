name: CI

on:
push:
branches: [main]
pull_request:

jobs:
lint:
runs-on: ubuntu-latest
steps:
- name: Checkout code
uses: actions/checkout@v3


  - name: Set up Python
    uses: actions/setup-python@v4
    with:
      python-version: "3.11"

  - name: Install dependencies
    run: |
      python -m pip install --upgrade pip
      pip install -r requirements-dev.txt
      pip install pre-commit

  - name: Run pre-commit hooks (Black, isort, Flake8)
    run: pre-commit run --all-files


test:
runs-on: ubuntu-latest
needs: lint
services:
mysql:
image: mysql:8.0
env:
MYSQL_ROOT_PASSWORD: ${{ secrets.DB_PASSWORD }}
MYSQL_DATABASE: ${{ secrets.DB_NAME }}
ports:
- 3306:3306
options: >-
--health-cmd="mysqladmin ping -h localhost -uroot -p${{ secrets.DB_PASSWORD }} --silent"
--health-interval=10s
--health-timeout=5s
--health-retries=10


env:
  TESTING: "1"
  IN_DOCKER: "0"
  DOCKER_DB_HOST: 127.0.0.1
  DOCKER_DB_USER: ${{ secrets.DB_USER }}
  DOCKER_DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  DOCKER_DB_NAME: ${{ secrets.DB_NAME }}
  TEST_DATABASE_URL: mysql+mysqlconnector://root:${{ secrets.DB_PASSWORD }}@127.0.0.1:3306/${{ secrets.DB_NAME }}
  PYTHONPATH: ${{ github.workspace }}

steps:
  - name: Checkout code
    uses: actions/checkout@v3

  - name: Set up Python
    uses: actions/setup-python@v4
    with:
      python-version: "3.11"

  - name: Install dependencies
    run: |
      python -m pip install --upgrade pip
      pip install -r requirements-dev.txt
      pip install mysql-connector-python

  - name: Wait for MySQL to be ready
    run: |
      echo "Waiting for MySQL..."
      for i in {1..60}; do
        if mysqladmin ping -h 127.0.0.1 -uroot -p${{ secrets.DB_PASSWORD }} --silent; then
          echo "MySQL is ready!"
          break
        fi
        echo "Waiting..."
        sleep 2
      done
      sleep 5

  - name: Debug environment info
    run: |
      echo "---------------- Environment Variables ----------------"
      echo "TESTING=$TESTING"
      echo "IN_DOCKER=$IN_DOCKER"
      echo "DOCKER_DB_HOST=$DOCKER_DB_HOST"
      echo "DOCKER_DB_USER=$DOCKER_DB_USER"
      echo "DOCKER_DB_PASSWORD=$DOCKER_DB_PASSWORD"
      echo "DOCKER_DB_NAME=$DOCKER_DB_NAME"
      echo "TEST_DATABASE_URL=$TEST_DATABASE_URL"
      echo "-------------------------------------------------------"
      echo "Python Path: $PYTHONPATH"
      echo "Listing current directory contents:"
      ls -la

  - name: Debug database connection
    run: |
      sudo apt-get update
      sudo apt-get install -y mysql-client
      mysql -h 127.0.0.1 -uroot -p${{ secrets.DB_PASSWORD }} -e "SHOW DATABASES;"

  - name: Create tables
    run: python -m app.create_tables

  - name: Run tests
    run: pytest -v

